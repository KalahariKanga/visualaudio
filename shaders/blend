uniform sampler2D texture;
uniform sampler2D lastFrame;

uniform float alpha;
uniform float driftX;
uniform float driftY;
uniform float zoom;
uniform float angle;

void main()
{
	vec4 lastColour;
	vec2 texcoord = vec2(gl_TexCoord[0]);
	vec2 drift = vec2(driftX,driftY);
	texcoord = vec2(texcoord.s, 1.0 - texcoord.t);
	gl_FragColor = texture2D(texture,texcoord);
	mat2 rot;
	rot[0] = vec2(cos(angle),sin(angle));
	rot[1] = vec2(-sin(angle),cos(angle));
	
	vec2 newcoord = (texcoord - vec2(0.5,0.5)) * zoom * rot + vec2(0.5,0.5) + drift;
	if(newcoord.x > 1) newcoord.x = 2 - newcoord.x;
	if(newcoord.y > 1) newcoord.y = 2 - newcoord.y;
	if(newcoord.x < 0) newcoord.x *= -1;
	if(newcoord.y < 0) newcoord.y *= -1;
	lastColour = texture2D(lastFrame, newcoord) * alpha;
	lastColour.a = 1;
	
	//lazy blending
	if(gl_FragColor.a < 1)
		gl_FragColor = lastColour;
}
